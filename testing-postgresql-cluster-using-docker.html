<!DOCTYPE html>
<html lang="en">
<head>
    <title>Alice/Development Notes &mdash; Testing a PostgreSQL slave/master cluster using Docker</title>
    <meta charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="http://aliceh75.github.io/theme/css/style.css"/>
</head>

<body>
    <div id="container">
        <div id="header">
                <div id="site-title"><a href="http://aliceh75.github.io">Alice/Development Notes</a></div>
        </div>

        <div id="contents">
    <div class="post">
        <div class="entry-meta">
            <div class="date">Mon 12 January 2015</div>
            <div class="author">By Alice Heaton</div>
                <div class="tag-list">
                        <a href="http://aliceh75.github.io/tag/docker" rel="tag">#docker</a>
                        <a href="http://aliceh75.github.io/tag/postgresql" rel="tag">#postgresql</a>
                        <a href="http://aliceh75.github.io/tag/python" rel="tag">#python</a>
                </div>
        </div>
        <div class="entry-main">
            <h1 class="entry-title">
                <a href="http://aliceh75.github.io/testing-postgresql-cluster-using-docker" title="Testing a PostgreSQL slave/master cluster using Docker"
                   rel="bookmark">Testing a PostgreSQL slave/master cluster using Docker</a>
            </h1>
            <div class="entry-content">
                  <h2>Using Docker for tests</h2>
<p>Performing functional tests on an application that requires a PostgreSQL server requires installing a single PostgreSQL server. This is generally easy. Performing functional tests on a application that requires a cluster of PostgreSQL servers is, on the other hand, a more difficult task. While Ubuntu and other distributions make it very easy to install a single instance of PostgreSQL, additional instances need to be setup manually. </p>
<p>Here <a href="https://www.docker.com">Docker</a> comes in handy: by allowing us to containerize PostgreSQL we can easily run multiple instances on a single host for the purpose of testing. By using the <a href="https://github.com/docker/docker-py">Docker Python API</a> we can then drive the cluster directly from our test suites.</p>
<p><em>Note: The examples in this post are based on <a href="https://www.docker.com">Docker</a> 1.4.1 and <a href="https://github.com/docker/docker-py">docker-py</a> 0.7.0</em></p>
<h2>The master server</h2>
<p>The master server just needs typical PostgreSQL configuration: <code>pg_hba.conf</code> and <code>postgresql.conf</code> need to be setup. We will also initialize the master server with the database we want to use for our tests. Here is the <a href="https://docs.docker.com/reference/builder/">Dockerfile</a>:</p>
<div class="highlight"><pre><span class="n">FROM</span> <span class="n">ubuntu</span><span class="o">:</span><span class="mf">12.04</span>

<span class="cp">#</span>
<span class="cp"># Install postgresql</span>
<span class="cp">#</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">postgresql</span><span class="o">-</span><span class="mf">9.1</span>

<span class="cp">#</span>
<span class="cp"># Setup configuration &amp; restart</span>
<span class="cp">#</span>
<span class="n">RUN</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;                                           \</span>
<span class="s">        host    all             all     0.0.0.0/0   md5   </span><span class="se">\n</span><span class="s"> \</span>
<span class="s">        host    replication     all     0.0.0.0/0   trust </span><span class="se">\n</span><span class="s"> \</span>
<span class="s">    &quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="mf">9.1</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">pg_hba</span><span class="p">.</span><span class="n">conf</span>                \
    <span class="o">&amp;&amp;</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;                                        \</span>
<span class="s">        listen_addresses = &#39;*&#39;                            </span><span class="se">\n</span><span class="s"> \</span>
<span class="s">        port = 5432                                       </span><span class="se">\n</span><span class="s"> \</span>
<span class="s">        wal_level = hot_standby                           </span><span class="se">\n</span><span class="s"> \</span>
<span class="s">        max_wal_senders = 3                               </span><span class="se">\n</span><span class="s"> \</span>
<span class="s">        wal_keep_segments = 256                           </span><span class="se">\n</span><span class="s"> \</span>
<span class="s">    &quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="mf">9.1</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">postgresql</span><span class="p">.</span><span class="n">conf</span>            \
    <span class="o">&amp;&amp;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">postgresql</span> <span class="n">restart</span>

<span class="cp">#</span>
<span class="cp"># Create the test suite user and database</span>
<span class="cp">#</span>
<span class="n">USER</span> <span class="n">postgres</span>
<span class="n">RUN</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">postgresql</span> <span class="n">start</span>                                              \
    <span class="o">&amp;&amp;</span> <span class="n">psql</span> <span class="o">-</span><span class="n">c</span> <span class="s">&quot;CREATE USER testsuite WITH UNENCRYPTED PASSWORD &#39;testsuite&#39;;&quot;</span> \
    <span class="o">&amp;&amp;</span> <span class="n">psql</span> <span class="o">-</span><span class="n">c</span> <span class="s">&quot;CREATE DATABASE testsuite WITH OWNER testsuite;&quot;</span>

<span class="n">EXPOSE</span> <span class="mi">5432</span>
<span class="n">CMD</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="mf">9.1</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">postgres</span> <span class="o">-</span><span class="n">D</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="mf">9.1</span><span class="o">/</span><span class="n">main</span> <span class="o">-</span><span class="n">c</span> <span class="n">config_file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="mf">9.1</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">postgresql</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<h2>The slave servers</h2>
<p>The slave servers also need <code>recovery.conf</code> setup properly, and an additional setup step: we need to start by getting a copy of the master database. Given that the containers will destroyed and re-created for every test suite, we can simply do the copy as part of the startup process. We will be using <a href="https://docs.docker.com/userguide/dockerlinks/">Docker links</a> to link the containers together, and the master host will be known as <code>pg_master</code>. Here is the Dockerfile:</p>
<div class="highlight"><pre><span class="n">FROM</span> <span class="n">ubuntu</span><span class="o">:</span><span class="mf">12.04</span>

<span class="cp">#</span>
<span class="cp"># Install postgresql</span>
<span class="cp">#</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">postgresql</span><span class="o">-</span><span class="mf">9.1</span>

<span class="cp">#</span>
<span class="cp"># Setup configuration</span>
<span class="cp">#</span>
<span class="n">RUN</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;                                               \</span>
<span class="s">        host    all             all     0.0.0.0/0   md5      </span><span class="se">\n</span><span class="s">  \</span>
<span class="s">        host    replication     all     0.0.0.0/0   trust    </span><span class="se">\n</span><span class="s">  \</span>
<span class="s">    &quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="mf">9.1</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">pg_hba</span><span class="p">.</span><span class="n">conf</span>                    \
    <span class="o">&amp;&amp;</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;                                            \</span>
<span class="s">        listen_addresses = &#39;*&#39;                               </span><span class="se">\n</span><span class="s">  \</span>
<span class="s">        port=5432                                            </span><span class="se">\n</span><span class="s">  \</span>
<span class="s">        hot_standby = on                                     </span><span class="se">\n</span><span class="s">  \</span>
<span class="s">    &quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="mf">9.1</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">postgresql</span><span class="p">.</span><span class="n">conf</span>                \
    <span class="o">&amp;&amp;</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;                                            \</span>
<span class="s">        standby_mode=&#39;on&#39;                                    </span><span class="se">\n</span><span class="s">  \</span>
<span class="s">        primary_conninfo = &#39;host=pg_master port=5432&#39;        </span><span class="se">\n</span><span class="s">  \</span>
<span class="s">        trigger_file = &#39;/tmp/trigger_file0&#39;                  </span><span class="se">\n</span><span class="s">  \</span>
<span class="s">    &quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="mf">9.1</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">recovery</span><span class="p">.</span><span class="n">conf</span>

<span class="cp">#</span>
<span class="cp"># Add startup script. This will perform initial replication and start</span>
<span class="cp"># the server. This must be run with the master server running and linked</span>
<span class="cp"># at pg_master</span>
<span class="cp">#</span>
<span class="n">COPY</span> <span class="n">run</span><span class="p">.</span><span class="n">sh</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="mf">9.1</span><span class="o">/</span><span class="n">run</span><span class="p">.</span><span class="n">sh</span>

<span class="n">USER</span> <span class="n">postgres</span>
<span class="n">EXPOSE</span> <span class="mi">5432</span>
<span class="n">CMD</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="mf">9.1</span><span class="o">/</span><span class="n">run</span><span class="p">.</span><span class="n">sh</span>
</pre></div>


<p>The script <code>run.sh</code> performs the initial database copy, and then starts the server:</p>
<div class="highlight"><pre><span class="c">#!/bin/sh</span>
<span class="c">#</span>
<span class="c"># Snapshot the initial database</span>
<span class="c">#</span>
/usr/bin/pg_basebackup -h pg_master -p 5432 -D /var/lib/postgresql/9.1/main2 -U postgres -v -P -x
cp /var/lib/postgresql/9.1/main/recovery.conf /var/lib/postgresql/9.1/main2
cp /var/lib/postgresql/9.1/main/server.* /var/lib/postgresql/9.1/main2
rm -Rf /var/lib/postgresql/9.1/main
mv /var/lib/postgresql/9.1/main2 /var/lib/postgresql/9.1/main
chown -R postgres:postgres /var/lib/postgresql/9.1/main

<span class="c">#</span>
<span class="c"># Start the postgresql server</span>
<span class="c">#</span>
/usr/lib/postgresql/9.1/bin/postgres -D /var/lib/postgresql/9.1/main -c <span class="nv">config_file</span><span class="o">=</span>/etc/postgresql/9.1/main/postgresql.conf
</pre></div>


<h2>Building and running the servers from Python</h2>
<p>Using the <a href="https://github.com/docker/docker-py">Docker Python API</a>, we can easily build, start, pause the servers at will. You can install <code>docker-py</code> easily:</p>
<div class="highlight"><pre><span class="n">pip</span> <span class="n">install</span> <span class="n">docker</span><span class="o">-</span><span class="n">py</span>
</pre></div>


<p>Here is some example code that builds the servers, starts them and simulates a temporary failure of the master server. It maps the master to port <code>5432</code> on the host, and the slaves to <code>5433</code>, <code>5434</code> and so on.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">docker</span>

<span class="n">slave_count</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">docker_url</span> <span class="o">=</span> <span class="s">&#39;unix://var/run/docker.sock&#39;</span>
<span class="n">docker_api_version</span> <span class="o">=</span> <span class="s">&#39;1.14&#39;</span>
<span class="n">master_image_path</span> <span class="o">=</span> <span class="s">&#39;/path/to/folder/containing/master/dockerfile&#39;</span>
<span class="n">slave_image_path</span> <span class="o">=</span> <span class="s">&#39;/path/to/folder/containing/slave/dockerfile&#39;</span>

<span class="n">master</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">slaves</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">build_image</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper function to build docker images &quot;&quot;&quot;</span>
    <span class="n">stream</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


<span class="c"># Create Docker client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">docker_url</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">docker_api_version</span><span class="p">)</span>

<span class="c"># Build images</span>
<span class="n">build_image</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">master_image_path</span><span class="p">,</span> <span class="s">&#39;test_master&#39;</span><span class="p">)</span>
<span class="n">build_image</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">slave_image_path</span><span class="p">,</span> <span class="s">&#39;test_slave&#39;</span><span class="p">)</span>

<span class="c"># Create master container and start it</span>
<span class="n">master</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_container</span><span class="p">(</span>
    <span class="n">image</span><span class="o">=</span><span class="s">&#39;test_master&#39;</span><span class="p">,</span>
    <span class="n">detach</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">ports</span><span class="o">=</span><span class="p">[</span><span class="mi">5432</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&#39;test_master&#39;</span>
<span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">start_container</span><span class="p">(</span>
    <span class="n">container</span><span class="o">=</span><span class="n">master</span><span class="p">[</span><span class="s">&#39;Id&#39;</span><span class="p">],</span>
    <span class="n">port_bindings</span><span class="o">=</span><span class="p">{</span><span class="mi">5432</span><span class="p">:</span><span class="mi">5432</span><span class="p">},</span>
<span class="p">)</span>

<span class="c"># Ensure the master is ready to be replicated</span>
<span class="n">times</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c"># Create slaves and start them</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">slave_count</span><span class="p">):</span>
    <span class="n">slaves</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_container</span><span class="p">(</span>
        <span class="n">image</span><span class="o">=</span><span class="s">&#39;test_slave&#39;</span><span class="p">,</span>
        <span class="n">detach</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">ports</span><span class="o">=</span><span class="p">[</span><span class="mi">5432</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s">&#39;test_slave_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">client</span><span class="o">.</span><span class="n">start_container</span><span class="p">(</span>
        <span class="n">container</span><span class="o">=</span><span class="n">slaves</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;Id&#39;</span><span class="p">],</span>
        <span class="n">port_bindings</span><span class="o">=</span><span class="p">{</span><span class="mi">5432</span><span class="p">:</span> <span class="mi">5433</span> <span class="o">+</span> <span class="n">i</span><span class="p">},</span>
        <span class="n">links</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;test_master&#39;</span><span class="p">:</span> <span class="s">&#39;pg_master&#39;</span><span class="p">}</span>
    <span class="p">)</span>

<span class="c"># Now do some tests...</span>
<span class="n">my_tests_with_servers_up</span><span class="p">()</span>

<span class="c"># Bring master down temporarily, test again.</span>
<span class="n">client</span><span class="o">.</span><span class="n">pause_container</span><span class="p">(</span><span class="n">container</span><span class="o">=</span><span class="n">master</span><span class="p">[</span><span class="s">&#39;Id&#39;</span><span class="p">])</span>
<span class="n">my_tests_with_master_down</span><span class="p">()</span>

<span class="c"># Bring master back up, test again.</span>
<span class="n">client</span><span class="o">.</span><span class="n">unpause_container</span><span class="p">(</span><span class="n">container</span><span class="o">=</span><span class="n">master</span><span class="p">[</span><span class="s">&#39;Id&#39;</span><span class="p">])</span>
<span class="n">my_tests_with_master_back</span><span class="p">()</span>

<span class="c"># Stop and delete all containers</span>
<span class="n">client</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">container</span><span class="o">=</span><span class="n">master</span><span class="p">[</span><span class="s">&#39;Id&#39;</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">slave_count</span><span class="p">):</span>
    <span class="n">client</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">container</span><span class="o">=</span><span class="n">slaves</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;Id&#39;</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
            </div>
        </div>
    </div>
        </div>

        <div id="footer">
            <p>Alice online: <a href="http://github.com/aliceh75">GitHub</a> <a href="https://twitter.com/aliceheaton75">Twitter</a></p>
            <p>Site generated by <a href="http://pelican.readthedocs.org">Pelican</a>, theme loosely based on <a href="https://github.com/tbunnyman/pelican-chunk">Chunk</a></p>
            <p>All content by Alice Heaton, licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
               <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
            </p>
        </div>
    </div>
</body>
</html>