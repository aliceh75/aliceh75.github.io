<!DOCTYPE html>
<html lang="en">
<head>
    <title>Alice/Development Notes &mdash; Implementing a CKAN permission plugin</title>
    <meta charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="http://aliceh75.github.io/theme/css/style.css"/>
</head>

<body>
    <div id="container">
        <div id="header">
                <div id="site-title"><a href="http://aliceh75.github.io">Alice/Development Notes</a></div>
        </div>

        <div id="contents">
    <div class="post">
        <div class="entry-meta">
            <div class="date">Mon 23 June 2014</div>
            <div class="author">By Alice Heaton</div>
                <div class="tag-list">
                        <a href="http://aliceh75.github.io/tag/ckan" rel="tag">#ckan</a>
                </div>
        </div>
        <div class="entry-main">
            <h1 class="entry-title">
                <a href="http://aliceh75.github.io/implementing-ckan-permission-plugin" title="Implementing a CKAN permission plugin"
                   rel="bookmark">Implementing a CKAN permission plugin</a>
            </h1>
            <div class="entry-content">
                  <h2>Overview</h2>
<p><a href="http://ckan.org">CKAN</a> implements a permission system based on roles, permissions and authorization functions which can be overridden by plugins. I used to this to implement the <a href="https://GitHub.com/NaturalHistoryMuseum/ckanext-userdatasets">ckanext-userdatasets</a> plugin. </p>
<p>CKAN users within an organization can have one of three roles:</p>
<ul>
<li><em>admins</em> who have all permissions on the organization and it's datasets;</li>
<li><em>editors</em> who can create, edit and delete any dataset in the organization;</li>
<li><em>members</em> who can view private datasets.</li>
</ul>
<p>The aim of this plugin is to allow users with the <em>member</em> role to create datasets in an organization without having the permission to edit or delete other users' datasets. CKAN does not currently allow us to create new roles - so what the plugin does is <em>add</em> permissions to the member role. We do this rather than <em>remove</em> permissions from the editor role because we want to keep the editor role separate from the admin role; but also because <em>adding</em> permissions means that, should the plugin fail, you'd end up with some users having less permissions, rather than some users having more permissions.</p>
<p>Note: This was implemented for CKAN 2.2. </p>
<h2>Overriding auth functions</h2>
<p>I will assume you are familiar with writing CKAN extensions - if not, have a look at <a href="http://docs.ckan.org/en/ckan-2.2/extensions/index.html">the documentation on writing CKAN extensions</a>, and in particular the page on <a href="http://docs.ckan.org/en/ckan-2.2/extensions/tutorial.html#implementing-the-iauthfunctions-plugin-interface">implementing the IAuthFunctions plugin interlace</a></p>
<p>So the first thing to do is to identify which authentication functions to override. In this case, we want to override anything that has to do with creating or editing packages and related objects. A look at <code>ckan.logic.auth</code> will tell what us what authorization functions exist. From there we can see that we want to override:</p>
<ul>
<li><code>package_create</code></li>
<li><code>package_delete</code></li>
<li><code>package_update</code></li>
<li><code>resource_create</code></li>
<li><code>resource_delete</code></li>
<li><code>resource_update</code></li>
</ul>
<p>We do not want to fully override the functionality of those functions; we only want to treat a special case: allow a user who has the <code>member</code> role in an organization to create a dataset, and edit/delete datasets they have created. For all other cases we want to fallback on CKAN's default implementation. CKAN does not provide a mechanism for falling back to the default function (though <a href="https://github.com/ckan/ckan/issues/1784">there is an implementation in the works</a>), but it is easy enough to implement - I've created my own <code>get_default_auth</code> and <code>get_default_action</code> which I can easily replace when CKAN supports this.</p>
<p>To make it easy to map various auth functions to each other I have used the same structure used by CKAN itself, so my functions reside in <code>ckanext.userdatasets.logic.auth.create.package_create</code>, <code>ckanext.userdatasets.logic.auth.delete.package_delete</code>, etc. and we can map them using a simple loop. Note that the plugin also provides support for <a href="https://github.com/ckan/ckan/tree/1251-resource-view">CKAN's 1251 branch</a>, so it also checks for <code>resource_view_*</code> functions and override them if they exist.</p>
<p>Here is the code for plugin.py at that stage of the implementation:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">ckan.plugins</span> <span class="kn">as</span> <span class="nn">p</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">class</span> <span class="nc">UserDatasetsPlugin</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">SingletonPlugin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;UserDatasetsPlugin</span>

<span class="sd">    This plugin replaces dataset and resource authentication calls to allow</span>
<span class="sd">    users with the &#39;Member&#39; role to create datasets, and edit/delete their</span>
<span class="sd">    own datasets (but not others).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">p</span><span class="o">.</span><span class="n">implements</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">IAuthFunctions</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">implements</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">IConfigurable</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implementation of IConfigurable.configure&quot;&quot;&quot;</span>
        <span class="n">config</span><span class="p">[</span><span class="s">&#39;default_auth_module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;userdatasets.default_auth_module&#39;</span><span class="p">,</span> <span class="s">&#39;ckan.logic.auth&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_auth_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implementation of IAuthFunctions.get_auth_functions&quot;&quot;&quot;</span>
        <span class="c"># We override all of create/update/delete for packages, resources and resource views.</span>
        <span class="n">auth_functions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="s">&#39;update&#39;</span><span class="p">,</span> <span class="s">&#39;delete&#39;</span><span class="p">]:</span>
            <span class="n">default_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;default_auth_module&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">action</span><span class="p">)</span>
            <span class="n">uds_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s">&#39;ckanext.userdatasets.logic.auth.&#39;</span> <span class="o">+</span> <span class="n">action</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atype</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;package&#39;</span><span class="p">,</span> <span class="s">&#39;resource&#39;</span><span class="p">,</span> <span class="s">&#39;resource_view&#39;</span><span class="p">]:</span>
                <span class="n">fn_name</span> <span class="o">=</span> <span class="n">atype</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">action</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">default_module</span><span class="p">,</span> <span class="n">fn_name</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">uds_module</span><span class="p">,</span> <span class="n">fn_name</span><span class="p">):</span>
                    <span class="n">auth_functions</span><span class="p">[</span><span class="n">fn_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">uds_module</span><span class="p">,</span> <span class="n">fn_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">auth_functions</span>


<span class="k">def</span> <span class="nf">get_default_auth</span><span class="p">(</span><span class="n">ftype</span><span class="p">,</span> <span class="n">function_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the default auth function</span>

<span class="sd">    @param type: The type of auth function (create/update/delete)</span>
<span class="sd">    @param function: Name of function. It must exists.</span>
<span class="sd">    @return: The auth function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;default_auth_module&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ftype</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">default_module</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
</pre></div>


<p>CKAN provides a number of usefull functions to test permissions (though in practice CKAN plugins should not import CKAN functions directly, we would otherwise have to re-implement those functions exactly as they are). In addition to those, we add two of our own to help our auth functions:</p>
<ul>
<li><code>user_is_member_of_package_org</code> which allows us to check if a given user has the member role on the given package's organization; and</li>
<li><code>user_owns_package_as_member</code> which allows us to check if the given user created the given package and has the member role in the package's organization.</li>
</ul>
<p>The implementation is as follows:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">ckan</span> <span class="kn">import</span> <span class="n">logic</span>
<span class="kn">from</span> <span class="nn">ckan.new_authz</span> <span class="kn">import</span> <span class="n">users_role_for_group_or_org</span>

<span class="k">def</span> <span class="nf">user_is_member_of_package_org</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">package</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return True if the package is in an organization and the user has the member role in that organization</span>

<span class="sd">    @param user: A user object</span>
<span class="sd">    @param package: A package object</span>
<span class="sd">    @return: True if the user has the &#39;member&#39; role in the organization that owns the package, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">package</span><span class="o">.</span><span class="n">owner_org</span><span class="p">:</span>
        <span class="n">role_in_org</span> <span class="o">=</span> <span class="n">users_role_for_group_or_org</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="n">owner_org</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">role_in_org</span> <span class="o">==</span> <span class="s">&#39;member&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
   <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">user_owns_package_as_member</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">package</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks that the given user created the package, and has the &#39;member&#39; role in the organization that owns the package.</span>

<span class="sd">    @param user: A user object</span>
<span class="sd">    @param package: A package object</span>
<span class="sd">    @return: True if the user created the package and has the &#39;member&#39; role in the organization to which package belongs.</span>
<span class="sd">             False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">user_is_member_of_package_org</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">package</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">package</span><span class="o">.</span><span class="n">creator_user_id</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">package</span><span class="o">.</span><span class="n">creator_user_id</span>

    <span class="k">return</span> <span class="bp">False</span>
</pre></div>


<p>From there the implementation of the auth functions is straight forward. As an example here is <code>resource_create</code>:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">ckan.logic.auth</span> <span class="kn">import</span> <span class="n">get_package_object</span><span class="p">,</span> <span class="n">get_resource_object</span>
<span class="kn">from</span> <span class="nn">ckan.new_authz</span> <span class="kn">import</span> <span class="n">users_role_for_group_or_org</span><span class="p">,</span> <span class="n">has_user_permission_for_some_org</span>
<span class="kn">from</span> <span class="nn">ckanext.userdatasets.plugin</span> <span class="kn">import</span> <span class="n">get_default_auth</span>


<span class="k">def</span> <span class="nf">resource_create</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;auth_user_obj&#39;</span><span class="p">]</span>
    <span class="n">package</span> <span class="o">=</span> <span class="n">get_package_object</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user_owns_package_as_member</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">package</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">user_is_member_of_package_org</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">package</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>

    <span class="n">fallback</span> <span class="o">=</span> <span class="n">get_default_auth</span><span class="p">(</span><span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="s">&#39;resource_create&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fallback</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span>
</pre></div>


<p>One major <strong>gotcha</strong> is that <code>package_create</code> may be called without a defined organization. If that is the case, the function should return success if the given user can create packages on any organization. This is not documented but obvious from CKAN's implementation.</p>
<h2>Override validators</h2>
<p>Unfortunately overriding auth functions is not enough. Some of CKAN's validators also perform auth tests - an issue <a href="https://github.com/ckan/ckan/issues/1775">that should be resolved soon</a>. Until the issue is resolved, we must override those validators to allow packages to be created.</p>
<p>The validators that need to be overridden have to be identified by trial and error. <code>package_create</code> (itself an action) calls <code>ckan.lib.plugins.plugin_validate</code> on the form data, which uses the validator <code>ckan.logic.validators.owner_org_validator</code> and which in turns calls <code>ckan.new_authz.has_user_permission_for_group_or_org</code>. The latter fails us. Unfortunately, nothing in the call stack below <code>package_create</code> can be overridden using CKAN's API, so the only option is to override that one.</p>
<p>What I have done is re-implement (ahem, copy) the functionality, but changed the list of validators used to validate the input - replacing, in that particular context, <code>ckan.logic.validators.owner_org_validator</code> with our own copy. The change is minor:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">ckan.logic.validators</span> <span class="kn">import</span> <span class="n">owner_org_validator</span> <span class="k">as</span> <span class="n">default_oov</span>
<span class="kn">from</span> <span class="nn">ckanext.userdatasets.logic.validators</span> <span class="kn">import</span> <span class="n">owner_org_validator</span> <span class="k">as</span> <span class="n">uds_oov</span>
<span class="p">[</span><span class="o">.....</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">package_create</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>
    <span class="p">[</span><span class="o">....</span><span class="p">]</span>
    <span class="n">package_type</span> <span class="o">=</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span>
    <span class="n">package_plugin</span> <span class="o">=</span> <span class="n">lib_plugins</span><span class="o">.</span><span class="n">lookup_package_plugin</span><span class="p">(</span><span class="n">package_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;schema&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;schema&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">package_plugin</span><span class="o">.</span><span class="n">create_package_schema</span><span class="p">()</span>
    <span class="c"># We modify the schema here to replace owner_org_validator by our own</span>
    <span class="k">if</span> <span class="s">&#39;owner_org&#39;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
        <span class="n">schema</span><span class="p">[</span><span class="s">&#39;owner_org&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">uds_oov</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="n">default_oov</span> <span class="k">else</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="s">&#39;owner_org&#39;</span><span class="p">]]</span>

    <span class="p">[</span><span class="o">.....</span><span class="p">]</span>
</pre></div>


<p>The implementation of <code>ckanext.userdatasets.logic.validators.owner_org_validator</code> itself is straightforward:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">ckan.lib.navl.dictization_functions</span> <span class="kn">as</span> <span class="nn">df</span>
<span class="kn">from</span> <span class="nn">ckan.new_authz</span> <span class="kn">import</span> <span class="n">users_role_for_group_or_org</span>
<span class="kn">from</span> <span class="nn">ckan.logic.validators</span> <span class="kn">import</span> <span class="n">owner_org_validator</span> <span class="k">as</span> <span class="n">default_oov</span>

<span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">missing</span>

<span class="k">def</span> <span class="nf">owner_org_validator</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">owner_org</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;auth_user_obj&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">owner_org</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">missing</span> <span class="ow">and</span> <span class="n">owner_org</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">owner_org</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">users_role_for_group_or_org</span><span class="p">(</span><span class="n">owner_org</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s">&#39;member&#39;</span><span class="p">:</span>
            <span class="k">return</span>

    <span class="n">default_oov</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</pre></div>


<p><code>ckan.logic.action.update.package_update</code> had to be overridden in the same way as <code>package_create</code> was.</p>
<h2>Other Overrides</h2>
<p>A final action that we had to override is one that lists the organizations in which a given role can create a dataset - <code>organization_list_for_user</code>. As per the auth functions, we can override the action by implementing <code>IActions</code> and our implementation can treat our special case and fallback to the default implementation otherwise.</p>
<h2>Conclusion</h2>
<p>CKAN's plugin model has allowed us to plug into it's authorization system and add permissions at a level (the dataset) that was not initial supported. CKAN allowed us to do this without resorting to hacks (even though it required a lot of code digging!). Doing so however has forced us to reproduce the entirety of the <code>package_create</code> and <code>package_update</code> actions, which ties the plugin very closely to CKAN's implementation and thus to the version of CKAN the plugin runs on. Hopefully this is issue will be solved in the near future - allowing the plugin to function by only overriding auth functions, not actions.</p>
            </div>
        </div>
    </div>
        </div>

        <div id="footer">
            <p>Alice online: <a href="http://github.com/aliceh75">GitHub</a> <a href="https://twitter.com/aliceheaton75">Twitter</a></p>
            <p>Site generated by <a href="http://pelican.readthedocs.org">Pelican</a>, theme loosely based on <a href="https://github.com/tbunnyman/pelican-chunk">Chunk</a></p>
            <p>All content by Alice Heaton, licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
               <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
            </p>
        </div>
    </div>
</body>
</html>